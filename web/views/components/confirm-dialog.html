<!-- 确认对话框组件 - 使用 Alpine.js + DaisyUI -->
<dialog id="confirm-dialog-modal" class="modal" x-data="confirmDialog()" @confirm-dialog.window="show($event.detail)">
    <div class="modal-box" x-show="isOpen"
        x-transition:enter="transition-opacity duration-300" x-transition:leave="transition-opacity duration-300">
        <!-- 图标 -->
        <div class="alert alert-warning mb-4">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
                <div>
                    <h3 class="font-bold text-lg" x-text="title"></h3>
                    <p class="text-sm mt-1" x-text="message"></p>
                </div>
            </div>
        </div>

        <!-- 按钮组 -->
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost" @click="close()">
                    取消
                </button>
                <button class="btn btn-warning" @click="confirm()" x-text="confirmText">
                </button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    function confirmDialog() {
        return {
            // Alpine will call init() when component is initialized
            init() {
                // 监听全局事件，兼容 window.dispatchEvent 和 Alpine 的 $dispatch
                const handler = (e) => {
                    try {
                        if (e && e.detail) {
                            this.show(e.detail);
                        }
                    } catch (err) {
                        console.error('confirm-dialog 事件处理失败:', err);
                    }
                };

                // 绑定到 window（也会接收从 document/bubbled 发来的事件）
                window.addEventListener('confirm-dialog', handler);

                // 可选：在组件被销毁时移除监听（Alpine 没有直接销毁 hook 这里不移除）
            },

            isOpen: false,
            title: '确认操作',
            message: '您确定要执行此操作吗？',
            confirmText: '确定',
            onConfirm: null,
            config: null,

            show(config) {
                this.title = config.title || '确认操作';
                this.message = config.message || '您确定要执行此操作吗？';
                this.confirmText = config.confirmText || '确定';
                this.onConfirm = config.onConfirm;
                this.config = config; // 存储配置
                this.isOpen = true;

                // 使用 HTML5 Dialog API 打开模态框
                setTimeout(() => {
                    const modal = document.getElementById('confirm-dialog-modal');
                    if (modal && typeof modal.showModal === 'function') {
                        modal.showModal();
                    }
                }, 50);
            },

            close() {
                this.isOpen = false;
                this.onConfirm = null;
                this.config = null; // 清除配置

                // 使用 HTML5 Dialog API 关闭模态框
                const modal = document.getElementById('confirm-dialog-modal');
                if (modal && typeof modal.close === 'function') {
                    modal.close();
                }
            },

            confirm() {
                // 优先使用 HTMX 范式：创建临时元素并通过 hx-* 发起请求
                if (this.config && this.config.url) {
                    const { url, method, data, target, swap } = this.config;

                    // 根据 method 映射到 hx-<verb>
                    const verb = (method || 'POST').toUpperCase();
                    const hxAttr = {
                        'POST': 'hx-post',
                        'PUT': 'hx-put',
                        'DELETE': 'hx-delete',
                        'GET': 'hx-get',
                        'PATCH': 'hx-patch'
                    }[verb] || 'hx-post';

                    // 创建临时触发元素（使用 <a> 更简单）
                    const el = document.createElement('a');
                    el.style.display = 'none';
                    el.setAttribute(hxAttr, url);

                    if (target) {
                        el.setAttribute('hx-target', target);
                    }

                    // 支持自定义 swap（回退到 outerHTML）
                    el.setAttribute('hx-swap', swap || 'outerHTML');

                    if (data) {
                        try {
                            el.setAttribute('hx-vals', JSON.stringify(data));
                        } catch (e) {
                            console.error('序列化 hx-vals 失败:', e);
                        }
                    }

                    document.body.appendChild(el);
                    // 告知 HTMX 处理新节点
                    if (typeof htmx !== 'undefined' && typeof htmx.process === 'function') {
                        htmx.process(el);
                        // 触发点击让 HTMX 发起请求
                        try {
                            el.click();
                        } catch (e) {
                            // 某些环境下 click() 可能抛错，使用 htmx.trigger 作为备用
                            try { htmx.trigger(el, 'click'); } catch (e2) { console.error(e2); }
                        }
                    } else {
                        console.error('htmx 未定义，无法发起请求');
                    }

                    // 清理临时元素（延迟以便 HTMX 能处理）
                    setTimeout(() => {
                        if (el && el.parentNode) el.parentNode.removeChild(el);
                    }, 3000);

                } else if (typeof this.onConfirm === 'function') {
                    // 回退到回调函数（如果传入了 onConfirm 回调）
                    try {
                        this.onConfirm();
                    } catch (e) {
                        console.error('onConfirm 回调失败:', e);
                    }
                }

                // 关闭对话框
                this.close();
            }
        };
    }
</script>

<!-- DaisyUI 样式已足够，无需额外自定义样式 -->