<!-- 确认对话框组件 - 使用 daisyUI 5 原生 dialog -->
<dialog id="confirm-dialog" class="modal" x-data="confirmDialog()">
    <div class="modal-box">
        <!-- 警告图标和标题 -->
        <div class="flex items-start gap-4 mb-4">
            <div class="avatar">
                <div class="w-12 rounded-full bg-warning/20 text-warning flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-lg" x-text="title"></h3>
                <p class="py-2 text-sm opacity-70" x-text="message"></p>
            </div>
        </div>

        <!-- 按钮组 -->
        <div class="modal-action">
            <button class="btn btn-ghost" @click="close()">取消</button>
            <button class="btn btn-warning" @click="confirm()" x-text="confirmText"></button>
        </div>
    </div>
    <!-- 背景遮罩 -->
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    function confirmDialog() {
        return {
            isOpen: false,
            title: '确认操作',
            message: '您确定要执行此操作吗？',
            confirmText: '确定',
            config: null,

            init() {
                // 监听全局确认对话框事件
                window.addEventListener('confirm-dialog', (e) => {
                    if (e && e.detail) {
                        this.show(e.detail);
                    }
                });
            },

            show(config) {
                this.title = config.title || '确认操作';
                this.message = config.message || '您确定要执行此操作吗？';
                this.confirmText = config.confirmText || '确定';
                this.config = config;
                this.isOpen = true;

                // 使用 HTML5 原生 dialog API
                const dialog = document.getElementById('confirm-dialog');
                if (dialog) {
                    dialog.showModal();
                }
            },

            close() {
                this.isOpen = false;
                this.config = null;
                const dialog = document.getElementById('confirm-dialog');
                if (dialog) {
                    dialog.close();
                }
            },

            confirm() {
                if (this.config && this.config.url) {
                    const { url, method, data, target, swap } = this.config;
                    const verb = (method || 'POST').toUpperCase();
                    const hxAttr = {
                        'POST': 'hx-post',
                        'PUT': 'hx-put',
                        'DELETE': 'hx-delete',
                        'GET': 'hx-get',
                        'PATCH': 'hx-patch'
                    }[verb] || 'hx-post';

                    // 创建临时元素触发 HTMX 请求
                    const el = document.createElement('button');
                    el.style.display = 'none';
                    el.setAttribute(hxAttr, url);

                    if (target) el.setAttribute('hx-target', target);
                    el.setAttribute('hx-swap', swap || 'outerHTML');
                    if (data) {
                        try {
                            el.setAttribute('hx-vals', JSON.stringify(data));
                        } catch (e) {
                            console.error('JSON stringify error:', e);
                        }
                    }

                    document.body.appendChild(el);

                    if (typeof htmx !== 'undefined') {
                        htmx.process(el);
                        el.click();
                        setTimeout(() => el.remove(), 3000);
                    }
                } else if (typeof this.config?.onConfirm === 'function') {
                    try {
                        this.config.onConfirm();
                    } catch (e) {
                        console.error('Confirm callback error:', e);
                    }
                }

                this.close();
            }
        };
    }
</script>