<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GODASH</title>

    <!-- Tailwind CSS 4 + daisyUI 5 (本地资源) -->
    <link href="/static/css/daisyui.css" rel="stylesheet" type="text/css" />
    <script src="/static/js/tailwind.js"></script>
    <link href="/static/css/daisyui-themes.css" rel="stylesheet" type="text/css" />

    <!-- Tailwind CSS 4.x + daisyUI 5 配置 -->
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            themes: {
                light: {
                    "primary": "#3b82f6",
                    "primary-focus": "#2563eb",
                    "primary-content": "#ffffff",
                    "secondary": "#64748b",
                    "secondary-focus": "#475569",
                    "secondary-content": "#ffffff",
                    "accent": "#14b8a6",
                    "accent-focus": "#0d9488",
                    "accent-content": "#ffffff",
                    "neutral": "#374151",
                    "neutral-focus": "#1f2937",
                    "neutral-content": "#ffffff",
                    "base-100": "#ffffff",
                    "base-200": "#f8fafc",
                    "base-300": "#f1f5f9",
                    "base-content": "#1e293b",
                    "info": "#3b82f6",
                    "success": "#10b981",
                    "warning": "#f59e0b",
                    "error": "#ef4444",
                },
                dark: {
                    "primary": "#60a5fa",
                    "primary-focus": "#3b82f6",
                    "primary-content": "#ffffff",
                    "secondary": "#94a3b8",
                    "secondary-focus": "#64748b",
                    "secondary-content": "#1e293b",
                    "accent": "#2dd4bf",
                    "accent-focus": "#14b8a6",
                    "accent-content": "#1e293b",
                    "neutral": "#9ca3af",
                    "neutral-focus": "#6b7280",
                    "neutral-content": "#1e293b",
                    "base-100": "#1e293b",
                    "base-200": "#111827",
                    "base-300": "#0f172a",
                    "base-content": "#f8fafc",
                    "info": "#60a5fa",
                    "success": "#34d399",
                    "warning": "#fbbf24",
                    "error": "#f87171",
                }
            }
        }
    </script>

    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/css/admin.css?v=20251024-menu-beautify">

    <!-- HTMX v2.0.7 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/htmx/2.0.7/htmx.min.js"></script>

    <!-- Alpine.js v3.15.0 -->
    <script defer src="https://cdn.bootcdn.net/ajax/libs/alpinejs/3.15.0/cdn.min.js"></script>

    <!-- 自定义 JS (添加版本号避免缓存) -->
    <script src="/static/js/app.js?v=20250118-daisyui0024"></script>
</head>

<body class="bg-base-200 text-base-content" x-data="initApp()" x-init="$app = window.app = $el.__x; updateActiveNav()"
    x-data="$store = Alpine.store">
    <template x-if="sidebarOpen">
        <button @click="$store.sidebarOpen = false; $dispatch('close-sidebar')"
            class="fixed top-4 right-4 z-[999] btn btn-circle btn-ghost btn-sm lg:hidden">
            <i class="fas fa-times"></i>
        </button>
    </template>
    <div class="flex min-h-screen">
        <!-- 侧边栏 -->
        {{template "components/sidebar.html"}}

        <!-- 主内容区 -->
        <div class="flex-1 transition-all duration-300"
            :class="{ 'lg:ml-64': true, 'ml-0': !sidebarOpen || window.innerWidth >= 1024 }">
            <!-- 顶部栏 -->
            {{template "components/header.html"}}

            <!-- 内容区域 - HTMX 直接加载到这里 -->
            <main class="p-6 flex-1 overflow-x-hidden">
                <!-- 默认加载仪表盘 -->
                <div hx-get="/dashboard" hx-trigger="load" hx-swap="innerHTML">
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-base-content/60">加载中...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div id="toast-container" class="fixed top-20 right-6 z-[9999] flex flex-col gap-2 max-w-96" x-data="toastManager()"
        @show-toast.window="showToast($event.detail)">
        <template x-for="toast in toasts" :key="toast.id">
            <div :class="`alert ${getToastClass(toast.type)} shadow-lg flex items-center justify-between`"
                x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-x-full" x-transition:enter-end="opacity-100 translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-x-0"
                x-transition:leave-end="opacity-0 translate-x-full">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <span x-html="toast.icon" class="flex-shrink-0"></span>
                    <span x-text="toast.message" class="flex-1 truncate"></span>
                </div>
                <button type="button" @click="removeToast(toast.id)"
                    class="btn btn-ghost btn-xs btn-circle ml-4 flex-shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </template>
    </div>

    <!-- Alpine.js 全局组件 -->
    <script>
        // Toast 管理器
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,

                showToast(detail) {
                    const id = this.nextId++;
                    const icons = {
                        success: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                        error: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                        warning: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
                        info: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                    };

                    const toast = {
                        id: id,
                        message: detail.message || '操作完成',
                        type: detail.type || 'info',
                        icon: icons[detail.type] || icons.info,
                        visible: true
                    };

                    this.toasts.push(toast);
                    setTimeout(() => this.removeToast(id), 3000);
                },

                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) {
                        this.toasts[index].visible = false;
                        setTimeout(() => this.toasts.splice(index, 1), 300);
                    }
                },

                getToastClass(type) {
                    return {
                        success: 'alert-success',
                        error: 'alert-error',
                        warning: 'alert-warning',
                        info: 'alert-info'
                    }[type] || 'alert-info';
                }
            };
        }

        // Alpine.js 全局应用状态
        function initApp() {
            return {
                sidebarOpen: window.innerWidth >= 1024,
                activeMenu: '/dashboard',

                setActiveMenu(path) {
                    this.activeMenu = path;
                },

                handleResize() {
                    if (window.innerWidth >= 1024) {
                        this.sidebarOpen = true;
                    }
                }
            }
        }

        // HTMX 配置和事件监听
        document.addEventListener('DOMContentLoaded', function () {
            // HTMX 事件处理
            document.body.addEventListener('htmx:afterSettle', function (evt) {
                // 检查是否是主内容区域的更新
                if (evt.detail.target?.tagName === 'MAIN' ||
                    (evt.detail.target?.parentElement?.tagName === 'MAIN')) {
                    setTimeout(() => {
                        updateActiveNav();
                        if (window.app) {
                            window.app.sidebarOpen = window.innerWidth >= 1024;
                        }
                    }, 50);
                }
            });

            // 响应式处理
            window.addEventListener('resize', () => {
                if (window.app) {
                    window.app.handleResize();
                }
            });
        });

        // 更新导航激活状态
        function updateActiveNav() {
            const path = window.location.pathname;
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('href') === path);
            });

            if (window.app) {
                window.app.setActiveMenu(path);
            }

            // 更新页面标题
            updatePageTitle(path);
        }

        // 更新页面标题
        function updatePageTitle(path) {
            const pageTitle = document.getElementById('page-title');
            if (!pageTitle) return;

            const titles = {
                '/dashboard': '仪表盘',
                '/users': '用户列表',
                '/users/roles': '角色管理',
                '/users/permissions': '权限管理',
                '/products': '商品列表',
                '/orders': '订单列表',
                '/settings': '系统设置'
            };

            pageTitle.textContent = titles[path] || '管理后台';
        }
    </script>

    <!-- 确认对话框组件 -->
    {{template "components/confirm-dialog.html"}}

    <!-- 订单详情模态框 - 使用 daisyUI 5 原生 dialog -->
    <dialog id="order-modal" class="modal">
        <div class="modal-box max-w-4xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-info" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                订单详情
            </h3>
            <div id="order-modal-content">
                <div class="text-center py-8">
                    <span class="loading loading-spinner loading-lg"></span>
                    <p class="mt-4">加载中...</p>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        // 模态框辅助函数
        window.showOrderModal = function () {
            document.getElementById('order-modal')?.showModal();
        };
        window.closeOrderModal = function () {
            document.getElementById('order-modal')?.close();
        };
    </script>
</body>

</html>