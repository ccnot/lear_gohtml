<!DOCTYPE html>
<html lang="zh-CN" data-theme="admin">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - HTMX Demo</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TailwindCSS Config -->
    <script>
        tailwind.config = {
            darkMode: ['class'],
            content: ["./web/views/**/*.html", "./web/static/js/**/*.js"],
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#1890ff',
                            hover: '#40a9ff',
                            active: '#096dd9'
                        },
                        success: {
                            DEFAULT: '#52c41a',
                            hover: '#73d13d',
                            active: '#389e0d'
                        },
                        warning: {
                            DEFAULT: '#faad14',
                            hover: '#ffc53d',
                            active: '#d48806'
                        },
                        error: {
                            DEFAULT: '#f5222d',
                            hover: '#ff4d4f',
                            active: '#cf1322'
                        },
                        info: {
                            DEFAULT: '#1890ff',
                            hover: '#40a9ff',
                            active: '#096dd9'
                        },
                        'sidebar-bg': '#001529',
                        'sidebar-hover': '#000c17',
                        'sidebar-text': 'rgba(255, 255, 255, 0.65)',
                        'sidebar-text-active': '#ffffff'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif']
                    },
                    sidebarWidth: {
                        DEFAULT: '240px',
                        collapsed: '80px'
                    },
                    headerHeight: {
                        DEFAULT: '64px',
                        mobile: '56px'
                    }
                },
            },
            plugins: [
                // DaisyUI plugin will be loaded via CDN
            ],
        }
    </script>

    <!-- DaisyUI CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />

    <!-- DaisyUI Config -->
    <script>
        window.daisyui = {
            themes: [
                {
                    admin: {
                        "primary": "#1890ff",
                        "primary-focus": "#096dd9",
                        "primary-content": "#ffffff",

                        "secondary": "#722ed1",
                        "secondary-focus": "#531dab",
                        "secondary-content": "#ffffff",

                        "accent": "#52c41a",
                        "accent-focus": "#389e0d",
                        "accent-content": "#ffffff",

                        "neutral": "#001529",
                        "neutral-focus": "#000c17",
                        "neutral-content": "rgba(255, 255, 255, 0.65)",

                        "base-100": "#ffffff",
                        "base-200": "#fafafa",
                        "base-300": "#f5f5f5",
                        "base-content": "rgba(0, 0, 0, 0.85)",

                        "info": "#1890ff",
                        "success": "#52c41a",
                        "warning": "#faad14",
                        "error": "#f5222d",
                    },
                },
                "light",
                "dark",
            ],
            darkTheme: "dark",
            base: true,
            styled: true,
            utils: true,
            logs: true,
            themeRoot: ":root",
        }
    </script>

    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/css/admin.css?v=20250118-modal-fix-001">

    <!-- HTMX v2.0.7 -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>

    <!-- Alpine.js v3.15.0 -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.0/dist/cdn.min.js"></script>

    <!-- 自定义 JS (添加版本号避免缓存) -->
    <script src="/static/js/app.js?v=20250118-daisyui0021"></script>
</head>

<body class="bg-base-200 text-base-content" x-data="initApp()" x-init="$app = window.app = $el.__x; updateActiveNav()"
    x-data="$store = Alpine.store">
    <template x-if="sidebarOpen">
        <button @click="$store.sidebarOpen = false; $dispatch('close-sidebar')"
            class="fixed top-4 right-4 z-[999] btn btn-circle btn-ghost btn-sm lg:hidden">
            <i class="fas fa-times"></i>
        </button>
    </template>
    <div class="flex min-h-screen">
        <!-- 侧边栏 -->
        {{template "components/sidebar.html"}}

        <!-- 主内容区 -->
        <div class="flex-1 transition-all duration-300"
            :class="{ 'lg:ml-64': true, 'ml-0': !sidebarOpen || window.innerWidth >= 1024 }">
            <!-- 顶部栏 -->
            {{template "components/header.html"}}

            <!-- 内容容器 - 这里是 HTMX 的目标区域 -->
            <div id="main-container" class="p-6 flex-1 overflow-x-hidden">
                <!-- 默认加载仪表盘 -->
                <div hx-get="/dashboard" hx-trigger="load" hx-target="#main-container" hx-swap="innerHTML">
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-base-content/60">加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div id="toast-container" class="fixed top-20 right-6 z-[9999] flex flex-col gap-2 max-w-96" x-data="toastManager()"
        @show-toast.window="showToast($event.detail)">
        <template x-for="toast in toasts" :key="toast.id">
            <div :class="`alert ${getToastClass(toast.type)} shadow-lg flex items-center justify-between`"
                x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-x-full" x-transition:enter-end="opacity-100 translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-x-0"
                x-transition:leave-end="opacity-0 translate-x-full">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <span x-html="toast.icon" class="flex-shrink-0"></span>
                    <span x-text="toast.message" class="flex-1 truncate"></span>
                </div>
                <button type="button" @click="removeToast(toast.id)"
                    class="btn btn-ghost btn-xs btn-circle ml-4 flex-shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </template>
    </div>

    <!-- Alpine.js 全局组件 -->
    <script>
        // Toast 管理器
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,

                showToast(detail) {
                    const id = this.nextId++;
                    const icons = {
                        success: '<i class="fas fa-check-circle"></i>',
                        error: '<i class="fas fa-exclamation-circle"></i>',
                        warning: '<i class="fas fa-exclamation-triangle"></i>',
                        info: '<i class="fas fa-info-circle"></i>'
                    };

                    const toast = {
                        id: id,
                        message: detail.message || '操作完成',
                        type: detail.type || 'info',
                        icon: icons[detail.type] || icons.info,
                        visible: true
                    };

                    this.toasts.push(toast);

                    // 3秒后自动移除
                    setTimeout(() => {
                        this.removeToast(id);
                    }, 3000);
                },

                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) {
                        this.toasts[index].visible = false;
                        setTimeout(() => {
                            this.toasts.splice(index, 1);
                        }, 300);
                    }
                },

                getToastClass(type) {
                    const classes = {
                        success: 'alert-success',
                        error: 'alert-error',
                        warning: 'alert-warning',
                        info: 'alert-info'
                    };
                    return classes[type] || 'alert-info';
                }
            };
        }

        // Alpine.js全局组件和工具函数
        function initApp() {
            return {
                // 移动端侧边栏状态
                sidebarOpen: window.innerWidth >= 1024,

                // 当前激活的菜单项
                activeMenu: '/dashboard',

                // 切换移动端侧边栏
                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                },

                // 设置激活菜单项
                setActiveMenu(path) {
                    this.activeMenu = path;
                },

                // 处理窗口大小变化
                handleResize() {
                    if (window.innerWidth >= 1024) {
                        this.sidebarOpen = true;
                    }
                }
            }
        }



        // 简单的主题切换函数 - 定义在全局作用域
        window.simpleThemeToggle = function (event) {
            event.preventDefault();
            console.log('🔄 开始切换主题...');

            const html = document.documentElement;
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const daisyuiTheme = newTheme === 'dark' ? 'dark' : 'light';  // 使用 DaisyUI 内置主题

            console.log('🔄 主题切换:', currentTheme, '->', newTheme, '| DaisyUI:', daisyuiTheme);

            // 设置 DaisyUI 主题
            html.setAttribute('data-theme', daisyuiTheme);

            // 更新 dark 类
            if (newTheme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            // 保存到 localStorage
            localStorage.setItem('theme', newTheme);

            // 更新图标
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (lightIcon && darkIcon) {
                if (newTheme === 'dark') {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            }

            console.log('✅ 主题切换完成! newTheme:', newTheme);
            console.log('🎨 当前 data-theme:', html.getAttribute('data-theme'));
        };

        // 获取当前主题状态
        function getCurrentTheme() {
            return localStorage.getItem('theme') || 'light';
        }



        // 初始化主题
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const theme = savedTheme || 'light'; // 默认浅色主题
            const daisyuiTheme = theme === 'dark' ? 'dark' : 'light';  // 使用 DaisyUI 内置主题

            console.log('🎨 初始化主题:', theme, '| DaisyUI:', daisyuiTheme);

            const html = document.documentElement;
            html.setAttribute('data-theme', daisyuiTheme);

            // 更新 dark 类
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            // 初始化图标状态
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (lightIcon && darkIcon) {
                if (theme === 'dark') {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            }

            console.log('✅ 主题初始化完成! theme:', theme, 'data-theme:', daisyuiTheme);
        }

        // 测试函数 - 可以在控制台中使用
        window.testTheme = function (theme) {
            document.documentElement.setAttribute('data-theme', theme);
            console.log('🎨 设置主题为:', theme, '| 当前 data-theme:', document.documentElement.getAttribute('data-theme'));
        };

        // HTMX 配置和事件监听
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化主题
            initTheme();

            // HTMX Toast 消息已移至 app.js 统一处理（带 URL 解码）

            // 更新导航激活状态 - 处理HTMX加载后侧边栏消失的问题
            document.body.addEventListener('htmx:afterSettle', function (evt) {
                const target = evt.detail.target;
                if (target && target.id === 'main-container') {
                    // 延迟执行以确保Alpine.js已更新DOM
                    setTimeout(() => {
                        updateActiveNav();
                        // 重新初始化侧边栏状态
                        const sidebar = document.querySelector('aside');
                        if (sidebar && window.app) {
                            // 确保侧边栏在大屏幕上显示，小屏幕上隐藏
                            window.app.sidebarOpen = window.innerWidth >= 1024;

                            // 更新用户管理二级菜单的展开状态
                            const currentPath = window.location.pathname;
                            const userMenuContainer = sidebar.querySelector('[x-data*=\"activeMenu\"]');
                            if (userMenuContainer && userMenuContainer.__x && userMenuContainer.__x.$data) {
                                // 如果当前路径在用户管理相关页面，确保二级菜单展开，否则收起
                                userMenuContainer.__x.$data.open = currentPath.startsWith('/users');
                            }
                        }
                    }, 50);
                }
            });

            // 监听窗口大小变化
            window.addEventListener('resize', () => {
                if (window.app) {
                    window.app.handleResize();
                }
            });
        });

        // 更新导航激活状态
        function updateActiveNav() {
            const path = window.location.pathname;
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === path) {
                    item.classList.add('active');
                }
            });

            // 更新Alpine.js状态
            if (window.app) {
                window.app.setActiveMenu(path);
            }

            // 更新用户管理菜单状态
            Alpine.store('isUsersActive', path.startsWith('/users'));
            Alpine.store('isUsersRolesActive', path.startsWith('/users/roles'));
            Alpine.store('isUsersPermissionsActive', path.startsWith('/users/permissions'));
        }
    </script>

    <!-- 确认对话框组件 -->
    {{template "components/confirm-dialog.html"}}

    <!-- 订单详情模态框 - 全局模态框，不受容器限制 -->
    <input type="checkbox" id="order-modal" class="modal-toggle" />
    <div class="modal" role="dialog">
        <div class="modal-box max-w-4xl shadow-xl border border-base-300">
            <label for="order-modal" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="fas fa-times"></i>
            </label>
            <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
                <i class="fas fa-file-invoice text-info"></i>
                订单详情
            </h3>
            <div id="order-modal-content">
                <!-- 详情内容将通过 HTMX 加载 -->
                <div class="text-center py-8">
                    <div class="loading loading-spinner loading-lg"></div>
                    <p class="mt-4">加载中...</p>
                </div>
            </div>
        </div>
        <label class="modal-backdrop" for="order-modal"></label>
    </div>
</body>

</html>