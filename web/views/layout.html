<!DOCTYPE html>
<html lang="zh-CN" data-theme="admin">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÆ°ÁêÜÂêéÂè∞ - HTMX Demo</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TailwindCSS Config -->
    <script>
        tailwind.config = {
            darkMode: ['class'],
            content: ["./web/views/**/*.html", "./web/static/js/**/*.js"],
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#1890ff',
                            hover: '#40a9ff',
                            active: '#096dd9'
                        },
                        success: {
                            DEFAULT: '#52c41a',
                            hover: '#73d13d',
                            active: '#389e0d'
                        },
                        warning: {
                            DEFAULT: '#faad14',
                            hover: '#ffc53d',
                            active: '#d48806'
                        },
                        error: {
                            DEFAULT: '#f5222d',
                            hover: '#ff4d4f',
                            active: '#cf1322'
                        },
                        info: {
                            DEFAULT: '#1890ff',
                            hover: '#40a9ff',
                            active: '#096dd9'
                        },
                        'sidebar-bg': '#001529',
                        'sidebar-hover': '#000c17',
                        'sidebar-text': 'rgba(255, 255, 255, 0.65)',
                        'sidebar-text-active': '#ffffff'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif']
                    },
                    sidebarWidth: {
                        DEFAULT: '240px',
                        collapsed: '80px'
                    },
                    headerHeight: {
                        DEFAULT: '64px',
                        mobile: '56px'
                    }
                },
            },
            plugins: [
                // DaisyUI plugin will be loaded via CDN
            ],
        }
    </script>

    <!-- DaisyUI CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />

    <!-- DaisyUI Config -->
    <script>
        window.daisyui = {
            themes: [
                {
                    admin: {
                        "primary": "#1890ff",
                        "primary-focus": "#096dd9",
                        "primary-content": "#ffffff",

                        "secondary": "#722ed1",
                        "secondary-focus": "#531dab",
                        "secondary-content": "#ffffff",

                        "accent": "#52c41a",
                        "accent-focus": "#389e0d",
                        "accent-content": "#ffffff",

                        "neutral": "#001529",
                        "neutral-focus": "#000c17",
                        "neutral-content": "rgba(255, 255, 255, 0.65)",

                        "base-100": "#ffffff",
                        "base-200": "#fafafa",
                        "base-300": "#f5f5f5",
                        "base-content": "rgba(0, 0, 0, 0.85)",

                        "info": "#1890ff",
                        "success": "#52c41a",
                        "warning": "#faad14",
                        "error": "#f5222d",
                    },
                },
                "light",
                "dark",
            ],
            darkTheme: "dark",
            base: true,
            styled: true,
            utils: true,
            logs: true,
            themeRoot: ":root",
        }
    </script>

    <!-- Font Awesome ÂõæÊ†á -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Ëá™ÂÆö‰πâÊ†∑Âºè -->
    <link rel="stylesheet" href="/static/css/admin.css?v=20250118-modal-fix-001">

    <!-- HTMX v2.0.7 -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>

    <!-- Alpine.js v3.15.0 -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.0/dist/cdn.min.js"></script>

    <!-- Ëá™ÂÆö‰πâ JS (Ê∑ªÂä†ÁâàÊú¨Âè∑ÈÅøÂÖçÁºìÂ≠ò) -->
    <script src="/static/js/app.js?v=20250118-daisyui0021"></script>
</head>

<body class="bg-base-200 text-base-content" x-data="initApp()" x-init="$app = window.app = $el.__x; updateActiveNav()"
    x-data="$store = Alpine.store">
    <template x-if="sidebarOpen">
        <button @click="$store.sidebarOpen = false; $dispatch('close-sidebar')"
            class="fixed top-4 right-4 z-[999] btn btn-circle btn-ghost btn-sm lg:hidden">
            <i class="fas fa-times"></i>
        </button>
    </template>
    <div class="flex min-h-screen">
        <!-- ‰æßËæπÊ†è -->
        {{template "components/sidebar.html"}}

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="flex-1 transition-all duration-300"
            :class="{ 'lg:ml-64': true, 'ml-0': !sidebarOpen || window.innerWidth >= 1024 }">
            <!-- È°∂ÈÉ®Ê†è -->
            {{template "components/header.html"}}

            <!-- ÂÜÖÂÆπÂÆπÂô® - ËøôÈáåÊòØ HTMX ÁöÑÁõÆÊ†áÂå∫Âüü -->
            <div id="main-container" class="p-6 flex-1 overflow-x-hidden">
                <!-- ÈªòËÆ§Âä†ËΩΩ‰ª™Ë°®Áõò -->
                <div hx-get="/dashboard" hx-trigger="load" hx-target="#main-container" hx-swap="innerHTML">
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-base-content/60">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ÈÄöÁü•ÂÆπÂô® -->
    <div id="toast-container" class="fixed top-20 right-6 z-[9999] flex flex-col gap-2 max-w-96" x-data="toastManager()"
        @show-toast.window="showToast($event.detail)">
        <template x-for="toast in toasts" :key="toast.id">
            <div :class="`alert ${getToastClass(toast.type)} shadow-lg flex items-center justify-between`"
                x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-x-full" x-transition:enter-end="opacity-100 translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-x-0"
                x-transition:leave-end="opacity-0 translate-x-full">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <span x-html="toast.icon" class="flex-shrink-0"></span>
                    <span x-text="toast.message" class="flex-1 truncate"></span>
                </div>
                <button type="button" @click="removeToast(toast.id)"
                    class="btn btn-ghost btn-xs btn-circle ml-4 flex-shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </template>
    </div>

    <!-- Alpine.js ÂÖ®Â±ÄÁªÑ‰ª∂ -->
    <script>
        // Toast ÁÆ°ÁêÜÂô®
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,

                showToast(detail) {
                    const id = this.nextId++;
                    const icons = {
                        success: '<i class="fas fa-check-circle"></i>',
                        error: '<i class="fas fa-exclamation-circle"></i>',
                        warning: '<i class="fas fa-exclamation-triangle"></i>',
                        info: '<i class="fas fa-info-circle"></i>'
                    };

                    const toast = {
                        id: id,
                        message: detail.message || 'Êìç‰ΩúÂÆåÊàê',
                        type: detail.type || 'info',
                        icon: icons[detail.type] || icons.info,
                        visible: true
                    };

                    this.toasts.push(toast);

                    // 3ÁßíÂêéËá™Âä®ÁßªÈô§
                    setTimeout(() => {
                        this.removeToast(id);
                    }, 3000);
                },

                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) {
                        this.toasts[index].visible = false;
                        setTimeout(() => {
                            this.toasts.splice(index, 1);
                        }, 300);
                    }
                },

                getToastClass(type) {
                    const classes = {
                        success: 'alert-success',
                        error: 'alert-error',
                        warning: 'alert-warning',
                        info: 'alert-info'
                    };
                    return classes[type] || 'alert-info';
                }
            };
        }

        // Alpine.jsÂÖ®Â±ÄÁªÑ‰ª∂ÂíåÂ∑•ÂÖ∑ÂáΩÊï∞
        function initApp() {
            return {
                // ÁßªÂä®Á´Ø‰æßËæπÊ†èÁä∂ÊÄÅ
                sidebarOpen: window.innerWidth >= 1024,

                // ÂΩìÂâçÊøÄÊ¥ªÁöÑËèúÂçïÈ°π
                activeMenu: '/dashboard',

                // ÂàáÊç¢ÁßªÂä®Á´Ø‰æßËæπÊ†è
                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                },

                // ËÆæÁΩÆÊøÄÊ¥ªËèúÂçïÈ°π
                setActiveMenu(path) {
                    this.activeMenu = path;
                },

                // Â§ÑÁêÜÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
                handleResize() {
                    if (window.innerWidth >= 1024) {
                        this.sidebarOpen = true;
                    }
                }
            }
        }



        // ÁÆÄÂçïÁöÑ‰∏ªÈ¢òÂàáÊç¢ÂáΩÊï∞ - ÂÆö‰πâÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.simpleThemeToggle = function (event) {
            event.preventDefault();
            console.log('üîÑ ÂºÄÂßãÂàáÊç¢‰∏ªÈ¢ò...');

            const html = document.documentElement;
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const daisyuiTheme = newTheme === 'dark' ? 'dark' : 'light';  // ‰ΩøÁî® DaisyUI ÂÜÖÁΩÆ‰∏ªÈ¢ò

            console.log('üîÑ ‰∏ªÈ¢òÂàáÊç¢:', currentTheme, '->', newTheme, '| DaisyUI:', daisyuiTheme);

            // ËÆæÁΩÆ DaisyUI ‰∏ªÈ¢ò
            html.setAttribute('data-theme', daisyuiTheme);

            // Êõ¥Êñ∞ dark Á±ª
            if (newTheme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            // ‰øùÂ≠òÂà∞ localStorage
            localStorage.setItem('theme', newTheme);

            // Êõ¥Êñ∞ÂõæÊ†á
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (lightIcon && darkIcon) {
                if (newTheme === 'dark') {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            }

            console.log('‚úÖ ‰∏ªÈ¢òÂàáÊç¢ÂÆåÊàê! newTheme:', newTheme);
            console.log('üé® ÂΩìÂâç data-theme:', html.getAttribute('data-theme'));
        };

        // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÁä∂ÊÄÅ
        function getCurrentTheme() {
            return localStorage.getItem('theme') || 'light';
        }



        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const theme = savedTheme || 'light'; // ÈªòËÆ§ÊµÖËâ≤‰∏ªÈ¢ò
            const daisyuiTheme = theme === 'dark' ? 'dark' : 'light';  // ‰ΩøÁî® DaisyUI ÂÜÖÁΩÆ‰∏ªÈ¢ò

            console.log('üé® ÂàùÂßãÂåñ‰∏ªÈ¢ò:', theme, '| DaisyUI:', daisyuiTheme);

            const html = document.documentElement;
            html.setAttribute('data-theme', daisyuiTheme);

            // Êõ¥Êñ∞ dark Á±ª
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            // ÂàùÂßãÂåñÂõæÊ†áÁä∂ÊÄÅ
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (lightIcon && darkIcon) {
                if (theme === 'dark') {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            }

            console.log('‚úÖ ‰∏ªÈ¢òÂàùÂßãÂåñÂÆåÊàê! theme:', theme, 'data-theme:', daisyuiTheme);
        }

        // ÊµãËØïÂáΩÊï∞ - ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞‰∏≠‰ΩøÁî®
        window.testTheme = function (theme) {
            document.documentElement.setAttribute('data-theme', theme);
            console.log('üé® ËÆæÁΩÆ‰∏ªÈ¢ò‰∏∫:', theme, '| ÂΩìÂâç data-theme:', document.documentElement.getAttribute('data-theme'));
        };

        // HTMX ÈÖçÁΩÆÂíå‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('DOMContentLoaded', function () {
            // ÂàùÂßãÂåñ‰∏ªÈ¢ò
            initTheme();

            // HTMX Toast Ê∂àÊÅØÂ∑≤ÁßªËá≥ app.js Áªü‰∏ÄÂ§ÑÁêÜÔºàÂ∏¶ URL Ëß£Á†ÅÔºâ

            // Êõ¥Êñ∞ÂØºËà™ÊøÄÊ¥ªÁä∂ÊÄÅ - Â§ÑÁêÜHTMXÂä†ËΩΩÂêé‰æßËæπÊ†èÊ∂àÂ§±ÁöÑÈóÆÈ¢ò
            document.body.addEventListener('htmx:afterSettle', function (evt) {
                const target = evt.detail.target;
                if (target && target.id === 'main-container') {
                    // Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øùAlpine.jsÂ∑≤Êõ¥Êñ∞DOM
                    setTimeout(() => {
                        updateActiveNav();
                        // ÈáçÊñ∞ÂàùÂßãÂåñ‰æßËæπÊ†èÁä∂ÊÄÅ
                        const sidebar = document.querySelector('aside');
                        if (sidebar && window.app) {
                            // Á°Æ‰øù‰æßËæπÊ†èÂú®Â§ßÂ±èÂπï‰∏äÊòæÁ§∫ÔºåÂ∞èÂ±èÂπï‰∏äÈöêËóè
                            window.app.sidebarOpen = window.innerWidth >= 1024;

                            // Êõ¥Êñ∞Áî®Êà∑ÁÆ°ÁêÜ‰∫åÁ∫ßËèúÂçïÁöÑÂ±ïÂºÄÁä∂ÊÄÅ
                            const currentPath = window.location.pathname;
                            const userMenuContainer = sidebar.querySelector('[x-data*=\"activeMenu\"]');
                            if (userMenuContainer && userMenuContainer.__x && userMenuContainer.__x.$data) {
                                // Â¶ÇÊûúÂΩìÂâçË∑ØÂæÑÂú®Áî®Êà∑ÁÆ°ÁêÜÁõ∏ÂÖ≥È°µÈù¢ÔºåÁ°Æ‰øù‰∫åÁ∫ßËèúÂçïÂ±ïÂºÄÔºåÂê¶ÂàôÊî∂Ëµ∑
                                userMenuContainer.__x.$data.open = currentPath.startsWith('/users');
                            }
                        }
                    }, 50);
                }
            });

            // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
            window.addEventListener('resize', () => {
                if (window.app) {
                    window.app.handleResize();
                }
            });
        });

        // Êõ¥Êñ∞ÂØºËà™ÊøÄÊ¥ªÁä∂ÊÄÅ
        function updateActiveNav() {
            const path = window.location.pathname;
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === path) {
                    item.classList.add('active');
                }
            });

            // Êõ¥Êñ∞Alpine.jsÁä∂ÊÄÅ
            if (window.app) {
                window.app.setActiveMenu(path);
            }

            // Êõ¥Êñ∞Áî®Êà∑ÁÆ°ÁêÜËèúÂçïÁä∂ÊÄÅ
            Alpine.store('isUsersActive', path.startsWith('/users'));
            Alpine.store('isUsersRolesActive', path.startsWith('/users/roles'));
            Alpine.store('isUsersPermissionsActive', path.startsWith('/users/permissions'));
        }
    </script>

    <!-- Á°ÆËÆ§ÂØπËØùÊ°ÜÁªÑ‰ª∂ -->
    {{template "components/confirm-dialog.html"}}

    <!-- ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü - ÂÖ®Â±ÄÊ®°ÊÄÅÊ°ÜÔºå‰∏çÂèóÂÆπÂô®ÈôêÂà∂ -->
    <input type="checkbox" id="order-modal" class="modal-toggle" />
    <div class="modal" role="dialog">
        <div class="modal-box max-w-4xl shadow-xl border border-base-300">
            <label for="order-modal" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="fas fa-times"></i>
            </label>
            <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
                <i class="fas fa-file-invoice text-info"></i>
                ËÆ¢ÂçïËØ¶ÊÉÖ
            </h3>
            <div id="order-modal-content">
                <!-- ËØ¶ÊÉÖÂÜÖÂÆπÂ∞ÜÈÄöËøá HTMX Âä†ËΩΩ -->
                <div class="text-center py-8">
                    <div class="loading loading-spinner loading-lg"></div>
                    <p class="mt-4">Âä†ËΩΩ‰∏≠...</p>
                </div>
            </div>
        </div>
        <label class="modal-backdrop" for="order-modal"></label>
    </div>
</body>

</html>