<!-- 商品编辑页面 -->
<div class="space-y-6">
    <!-- 页面标题 - 使用 hx-swap-oob 更新顶部标题 -->
    <div id="page-title" hx-swap-oob="true">编辑商品</div>

    <!-- 面包屑导航 -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="/dashboard" hx-get="/dashboard" hx-target="#main-container" hx-swap="innerHTML"
                    hx-push-url="true">首页</a></li>
            <li><a href="/products" hx-get="/products" hx-target="#main-container" hx-swap="innerHTML"
                    hx-push-url="true">商品管理</a></li>
            <li>编辑商品</li>
        </ul>
    </div>

    <!-- 编辑商品表单卡片 -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <!-- 页面头部 -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="card-title text-lg font-medium flex items-center gap-2">
                    <i class="fas fa-edit text-info"></i>
                    编辑商品信息
                </h2>
            </div>

            <!-- 商品表单 -->
            <form hx-put="/products/{{.Product.ID}}" hx-target="#main-container" hx-swap="innerHTML"
                @submit="submitForm($event)" x-data="productForm(true, {{.Product.ID}})"
                x-init="handleFormInit($event, '{{.Product}}')">

                <!-- 错误提示框 -->
                <div x-show="errors.length > 0" class="alert alert-error mb-4">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-exclamation-circle flex-shrink-0 mt-0.5"></i>
                        <div>
                            <p class="font-semibold">请修正以下错误：</p>
                            <ul class="list-disc list-inside space-y-1 text-sm mt-2">
                                <template x-for="error in errors">
                                    <li x-text="error"></li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 表单字段 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 左列：基本信息 -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium mb-4 text-base-content">基本信息</h3>

                        <!-- 商品名称 -->
                        <div class="form-control">
                            <label class="label">
                                商品名称 <span class="text-error">*</span>
                            </label>
                            <div class="relative">
                                <input class="input input-bordered w-full pl-10" type="text" name="name"
                                    placeholder="请输入商品名称" value="{{.Product.Name}}" required x-model="form.name"
                                    :class="{ 'input-error': errors.name }">
                                <i class="fas fa-box absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40"></i>
                            </div>
                            <div class="label-text-alt">商品的显示名称</div>
                        </div>

                        <!-- SKU（只读） -->
                        <div class="form-control">
                            <label class="label">
                                SKU
                            </label>
                            <div class="relative">
                                <input class="input input-bordered w-full pl-10" type="text" name="sku"
                                    value="{{.Product.SKU}}" readonly>
                                <i
                                    class="fas fa-barcode absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40"></i>
                            </div>
                            <div class="label-text-alt">SKU创建后不可修改</div>
                        </div>

                        <!-- 分类 -->
                        <div class="form-control">
                            <label class="label">
                                分类 <span class="text-error">*</span>
                            </label>
                            <select class="select select-bordered w-full" name="category" required
                                x-model="form.category" :class="{ 'input-error': errors.category }">
                                <option value="">请选择分类</option>
                                <option value="电子产品" {{if eq .Product.Category "电子产品" }}selected{{end}}>电子产品</option>
                                <option value="数码配件" {{if eq .Product.Category "数码配件" }}selected{{end}}>数码配件</option>
                                <option value="办公用品" {{if eq .Product.Category "办公用品" }}selected{{end}}>办公用品</option>
                                <option value="智能设备" {{if eq .Product.Category "智能设备" }}selected{{end}}>智能设备</option>
                                <option value="电脑配件" {{if eq .Product.Category "电脑配件" }}selected{{end}}>电脑配件</option>
                            </select>
                            <div class="label-text-alt">选择商品所属的分类</div>
                        </div>
                    </div>

                    <!-- 右列：价格和库存 -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium mb-4 text-base-content">库存与定价</h3>

                        <!-- 价格 -->
                        <div class="form-control">
                            <label class="label">
                                价格 <span class="text-error">*</span>
                            </label>
                            <div class="relative">
                                <input class="input input-bordered w-full pl-10" type="number" name="price"
                                    placeholder="请输入价格" value="{{.Product.Price}}" required step="0.01" min="0"
                                    x-model="form.price" :class="{ 'input-error': errors.price }">
                                <i
                                    class="fas fa-yen-sign absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40"></i>
                            </div>
                            <div class="label-text-alt">商品销售价格</div>
                        </div>

                        <!-- 库存 -->
                        <div class="form-control">
                            <label class="label">
                                库存 <span class="text-error">*</span>
                            </label>
                            <div class="relative">
                                <input class="input input-bordered w-full pl-10" type="number" name="stock"
                                    placeholder="请输入库存数量" value="{{.Product.Stock}}" required min="0"
                                    x-model="form.stock" :class="{ 'input-error': errors.stock }">
                                <i
                                    class="fas fa-database absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40"></i>
                            </div>
                            <div class="label-text-alt">当前库存数量</div>
                        </div>

                        <!-- 状态 -->
                        <div class="form-control">
                            <label class="label">
                                状态 <span class="text-error">*</span>
                            </label>
                            <select class="select select-bordered w-full" name="status" required x-model="form.status"
                                :class="{ 'input-error': errors.status }">
                                <option value="">请选择状态</option>
                                <option value="active" {{if eq .Product.Status "active" }}selected{{end}}>上架</option>
                                <option value="inactive" {{if eq .Product.Status "inactive" }}selected{{end}}>下架
                                </option>
                                <option value="out_of_stock" {{if eq .Product.Status "out_of_stock" }}selected{{end}}>缺货
                                </option>
                            </select>
                            <div class="label-text-alt">商品的销售状态</div>
                        </div>
                    </div>
                </div>

                <!-- 描述 -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium mb-2 text-base-content">商品描述</h3>
                    <div class="form-control">
                        <label class="label">商品描述</label>
                        <textarea class="textarea textarea-bordered h-24 w-full" name="description"
                            placeholder="请输入商品描述" x-model="form.description">{{.Product.Description}}</textarea>
                        <div class="label-text-alt">商品的详细描述信息</div>
                    </div>
                </div>

                <!-- 商品信息展示 -->
                <div class="alert alert-info mb-4">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-info-circle flex-shrink-0 mt-0.5"></i>
                        <div>
                            <p class="font-semibold">商品信息</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-base-content/60">创建时间：</span>
                                    <span>{{formatDateTimeFull .Product.CreatedAt}}</span>
                                </div>
                                <div>
                                    <span class="text-base-content/60">更新时间：</span>
                                    <span>{{formatDateTimeFull .Product.UpdatedAt}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 表单按钮 -->
                <div class="flex justify-end gap-3 pt-6 border-t border-base-300">
                    <a href="/products" class="btn btn-ghost" hx-get="/products" hx-target="#main-container"
                        hx-swap="innerHTML" hx-push-url="true">
                        <i class="fas fa-arrow-left mr-2"></i>
                        返回列表
                    </a>
                    <button type="submit" class="btn btn-primary" :disabled="loading">
                        <span x-show="loading" class="loading loading-spinner loading-sm mr-2"></span>
                        <i class="fas fa-save mr-2" x-show="!loading"></i>
                        更新商品
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function productForm(isEdit = false, productId = null) {
        return {
            loading: false,
            errors: {},
            form: {
                name: '',
                sku: '',
                category: '',
                price: '',
                stock: '',
                status: '',
                description: ''
            },

            handleFormInit(event, productData) {
                // 编辑模式：预填充表单数据
                if (isEdit && productData) {
                    this.form = {
                        name: productData.name || '',
                        sku: productData.sku || '',
                        category: productData.category || '',
                        price: productData.price || '',
                        stock: productData.stock || '',
                        status: productData.status || '',
                        description: productData.description || ''
                    };
                }
            },

            validateForm() {
                this.errors = {};
                let isValid = true;

                if (!this.form.name) {
                    this.errors.name = '商品名称不能为空';
                    isValid = false;
                }

                if (!this.form.category) {
                    this.errors.category = '请选择商品分类';
                    isValid = false;
                }

                if (!this.form.price || parseFloat(this.form.price) < 0) {
                    this.errors.price = '请输入有效的价格';
                    isValid = false;
                }

                if (!this.form.stock || parseInt(this.form.stock) < 0) {
                    this.errors.stock = '请输入有效的库存数量';
                    isValid = false;
                }

                if (!this.form.status) {
                    this.errors.status = '请选择商品状态';
                    isValid = false;
                }

                return isValid;
            },

            submitForm(event) {
                if (!this.validateForm()) {
                    return;
                }

                this.loading = true;

                // 让 HTMX 处理表单提交
                htmx.trigger(event.target, 'submit');

                // 监听提交完成
                setTimeout(() => {
                    this.loading = false;
                }, 500);
            }
        }
    }
</script>

<style>
    .form-control {
        @apply space-y-2;
    }

    .form-control label {
        @apply block text-sm font-medium mb-2;
    }

    .form-control .input,
    .form-control .textarea,
    .form-control .select {
        @apply w-full;
    }

    .form-control .input-error {
        @apply input-error;
    }

    .label-text-alt {
        @apply text-xs text-base-content/60 mt-1;
    }
</style>